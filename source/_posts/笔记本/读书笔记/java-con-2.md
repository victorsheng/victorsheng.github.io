---
title: java并发编程实战-第二章-线程安全性
author: Victor
abbrlink: 76319416
date: 2018-04-15 23:12:07
tags:
categories:
---
# 什么是线程安全型
 首先使代码正确运行，然后再提高代码速度。【正确编写并发程序的方法】

定义:当多个线程访问某个类时，不管是

1）运行时环境采用何种调度方式，
2）或者这些线程如何交替执行，
3）并在在主调代码中不需要任何额外的同步或者协同，
这个类能**始终**表现出**正确**的行为。

无状态对象一定是线程安全的

Java主要用`synchronized`做同步，这是一种独占的加锁方式，其他还包括volatile、显式锁（explicit lock）等。
- 如果出现线程安全问题，要怎么解决？
1）不在线程间共享（比如改成局部变量）
2）将状态改为不可变变量
3）访问状态变量时使用同步

# 原子性

## 竞争条件
- 由于不恰当的执行时序而出现不正确的结果是一种重要的情况,叫做竞争条件
- 当某个计算的正确性取决于多个线程的交替执行时序。最常见的竞态条件类型先检查后执行（Check-Then-Act）。

## 实例:延迟初始化中的竞争条件
单例模式,如果不加锁,返回不同的实例

## 复合操作

# 加锁机制
需要同时更新两个值


## 内置锁
- synchronized

## 重入
可重入意味着获取锁的操作的粒度是“线程”，而不是“调用”。重入的一种实现方法是为每一个锁关联一个获取计数值和一个所有者线程。当计数值为0时，这个锁没有被任何线程持有，当线程请求一个未被获取这个锁，计数值将递增，当线程退出同步代码块时，计数器会递减。当计数器为0时，释放该锁。


# 用锁来保护状态
锁可以使其保护的代码路径以串行的方式来访问。

- 如果用同步来协调对某个变量的访问时,那么在访问这个变量的所有位置上都需要使用同步
- 最好注释变量是由哪个锁锁保护

# 活跃性与性能
可以将执行时间较长的操作从锁中移除