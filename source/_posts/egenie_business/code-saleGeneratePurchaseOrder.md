---
title: 缺货销售订单生成采购单逻辑梳理
tags:
  - 采购
categories:
  - 业务梳理
abbrlink: 3167303399
date: 2017-11-21 23:28:00
---
# 缺货销售订单生成采购单逻辑梳理

# 入口:
* 采购单界面,一键生成采购单
* 订单处理界面
    * 勾选制定订单,生成采购单
    * 按照查询条件,生成采购单

# 实现逻辑:
* 查询基档案warehouse 是否需要采购,以及换货仓
* 查询之前的组号映射关系
    * 未关闭的采购单
    * 到货状态的唯一码
    * 更新之前组的到货数量
* 查询总的缺货销售订单数
* 分页生成采购单,默认5000单一组
    * 分页查询缺货销售订单
    * 根据系统参数 过滤掉申请退款的明细
    * 复制订单和订单明细,到新的数据结构
    (VSaleOrder,VSaleOrderDetail)-->(PmsDailyPurchase,PmsDailyPurchaseDetail)
        * 过滤采购完成
        * 过滤无需采购
        * 绝对唯一码规则.一条明细生成多个唯一码
    * 根据三级明细分配采购单号
        * 将未分拣墙上的设置到制定A组中
        * 单件不进分组
        * 相同订单的,使用上次的组号,同一订单组号继续使用
        * 大单量分组
        * 普通分组,并且分组下的订单数没有超过计划的订单数量
            * 使用已有的分组(按A-Z的优先顺序)
            * 创建新的分组
        * 合并最后一个分组信息
        * 回写新增的组至totalGroupMap(内存级别)
    * 批量填充唯一码
        * 生成36进制的唯一码
        * 唯一码规则:租户内唯一
        * 唯一码规则:9位唯一码
        * sku的唯一码,以1开头
    * (前绑定)根据采购单数,绑定订单和唯一码
    * (后绑定)先尝试使用为分拣墙上的sku,此部分无需采购,更新updateNum为-1
    * 持久化PmsPurchaseOrder
        * 汇总三级明细,生成二级明细
        * 次品仓业务(原采购单有相同sku的,用次品仓的货物换;没有的,增加采购数量)
            * 根据skuIds,查询换货仓的库存
            * 原采购数量<换货仓库存,新采购数量=换货仓数量
            * 原采购数量>=换货仓数量,新采购数量=原采购数量
            * 自动生成次品仓盘点单
        * 填充供货信息VendorSupply
            * 根据skuIds查询默认供应商
                * 设置采购周期和到货时间
                * 设置最小采购数量
                * 设置采购供应商
                * 设置采购价格
                    * 优先价格体系
                * 设置采购人(PDA推送的依据)      
            * 查询不到的取sku得采购信息,取sku得采购信息
                * 设置采购周期和到货时间
                * 设置最小采购数量
                * 设置采购价格
        * 反写采购单明细的信息到拿货明细
        * 二级明细业务处理: update 和 insert的
        * 持久化二级明细
        * 回写二级明细id到二点五级明细和三级明细
        * 移除掉不需要采购的采购单明细,和拿货订单明细,二级和三级需要同时移除
            * 规则一:供应商无需采购(之所以再次移除,是因为此处采购供应商)
            * 规则二:几天后到货的(目前已废弃)
        * 如果所有明细都移除了,则无需持久化采购单主表
        * 持久化(update 和 insert)订单主表            
    * 持久化PmsDailyPurchase,PmsDailyPurchaseDetail
* 返回生成采购单报告

