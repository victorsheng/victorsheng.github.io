---
title: 拜占庭将军问题
tags:
  - 分布式
categories:
  - 分布式
abbrlink: 1578577957
date: 2018-06-05 20:01:03
---
# 拜占庭将军问题
11位拜占庭将军去打仗, 他们各自有权力观测敌情并作出判断, 进攻或撤退, 那么怎么让他们只用传令兵达成一致呢?一种很符合直觉的方法就是投票,每位将军作出决定后都将结果"广播"给其余所有将军, 这样所有将军都能获得同样的11份(包括自己)结果, 取多数, 即可得到全军都同意的行为.但如果这11位将军中有间谍呢? 假设有9位忠诚的将军, 5位判断进攻, 4位判断撤退, 还有2个间谍恶意判断撤退, 虽然结果是错误的撤退, 但这种情况完全是允许的. 因为这11位将军依然保持着状态一致性.暂时从战争故事中抽离出来, 分布式数据库最糟糕的问题绝对不是写入或者读取失败, 而是状态不同步, 还感知不到. 这个的后果就是correctness不能保证, 那程序就没有任何意义了.2个间谍怎么破坏状态一致性呢? 他们跟5位判断进攻的将军说, 我们支持进攻, 那么这5位将军统计发现7位支持进攻, 4位支持撤退, 将发动进攻. 又跟4位撤退的将军说, 我们支持撤退, 一统计, 5票进攻, 6票撤退, 立马撤退. 这场战争必输无疑了.避免这种状态不同步的问题, 我称之为"广义拜占庭将军问题".Lamport继续将这个问题规约为更小的问题,解决广义拜占庭问题, 必须满足两个条件:对任意忠诚的将军来说, 他们看到的其余将军的决定必须是一样的, 不允许出现前文那种, 5位将军统计结果是7攻4撤, 另外4位将军是5攻6撤. 所有忠诚将军的决定对于其余所有忠诚将军都是一样的. 比如, V(1)表示1号将军的决定. 那么其余所有忠诚将军的统计表上, V(1)一定是一样的. 如果这点不能保证, 说明间谍已经可以直接颠覆指挥系统了, 系统怎样都是无效的, 哪怕达成了一致.上面的条件等价于如何让一个将军(可以是间谍, 论文叫commander)对所有接收者(lieutenant)的指令(order)保持一致? 这个我叫"狭义拜占庭将军问题".


# 什么是 Raft 算法？



Raft 算法是一种简单易懂的共识算法。它依靠 状态机 和 主从同步 的方式，在各个节点之间实现数据的一致性。

在学习Raft算法的时候，大家需要了解Raft的两个核心要点：

- 1.选取主节点
- 2.同步数据

Raft算法在选择主节点的过程中，也是通过多个节点之间的投票竞争。



说到这里，不得不说一下Raft算法的状态机。Raft算法为节点定义了三种角色：

1.Leader（主节点）

2.Follower（从节点）

3.Candidate（参与投票竞争的节点）

具体流程

第一步，在最初，还没有一个主节点的时候，所有节点的身份都是Follower。每一个节点都有自己的计时器，当计时达到了超时时间（Election Timeout），该节点会转变为Candidate。

第二步，成为Candidate的节点，会首先给自己投票，然后向集群中其他所有的节点发起请求，要求大家都给自己投票。

第三步，其他收到投票请求且还未投票的Follower节点会向发起者投票，发起者收到反馈通知后，票数增加。

第四步，当得票数超过了集群节点数量的一半，该节点晋升为Leader节点。Leader节点会立刻向其他节点发出通知，告诉大家自己才是老大。收到通知的节点全部变为Follower，并且各自的计时器清零。

这里需要说明一点，每个节点的超时时间都是不一样的。比如A节点的超时时间是3秒，B节点的超时时间是5秒，C节点的超时时间是4秒。这样一来，A节点将会最先发起投票请求，而不是所有节点同时发起。

为什么这样设计呢？设想如果所有节点同时发起投票，必然会导致大家的票数差不多，形成僵局，谁也当不成老大。

那么，成为Leader的节点是否就坐稳了老大的位置呢？并不是。Leader节点需要每隔一段时间向集群其他节点发送心跳通知，表明你们的老大还活着。

一旦Leader节点挂掉，发不出通知，那么计时达到了超时时间的Follower节点会转变为Candidate节点，发起选主投票，周而复始......


数据同步的流程

第一步，由客户端提交数据到Leader节点。

第二步，由Leader节点把数据复制到集群内所有的Follower节点。如果一次复制失败，会不断进行重试。

第三步，Follower节点们接收到复制的数据，会反馈给Leader节点。

第四步，如果Leader节点接收到超过半数的Follower反馈，表明复制成功。于是提交自己的数据，并通知客户端数据提交成功。

第五步，由Leader节点通知集群内所有的Follower节点提交数据，从而完成数据同步流程。


-----


Paxos 算法：

早期的共识算法，由拜占庭将军问题的提出者 Leslie Lamport 所发明。谷歌的分布式锁服务 Chubby 就是以 Paxos 算法为基础。




ZAB 算法：

Zookeeper 所使用的一致性算法，在流程上和 Raft 算法比较接近。




PBFT 算法：

区块链技术所使用的共识算法之一，适用于私有链的共识。